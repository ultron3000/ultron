<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Kurukshetra</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Marvel:wght@400;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <!-- HLS.js (keeps player's HLS support) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.1/dist/hls.min.js"></script>

  <style>
    /* Preserve original layout & behavior, reskinned for Agent Carter (retro red/blue) */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #0b0f12; }
    ::-webkit-scrollbar-thumb { background: #c0392b; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #e74c3c; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(12px);} to { opacity: 1; transform: translateY(0);} }
    .fade-in { animation: fadeIn 0.45s ease-out forwards; }

    .gradient-text { background: linear-gradient(90deg,#e74c3c,#2c3e50); -webkit-background-clip:text; color:transparent; }
    .marvel-font { font-family: 'Marvel', sans-serif; }
    .btn-ac { background: #c0392b; color: #fff; }
    .btn-ac:hover { filter: brightness(0.95); }

    /* keep modal/player sizing from original file */
    #modal-player { position: relative; padding-bottom: 56.25%; height: 0; background: black; }
    #modal-player video, #modal-player iframe { position:absolute; top:0; left:0; width:100%; height:100%; background:black; }

    body { background: #071021; color: #e8eef6; font-family: Roboto, system-ui, -apple-system, 'Segoe UI', Arial; }
    header { background: linear-gradient(90deg,#0b1220,#081219); border-bottom: 1px solid rgba(255,255,255,0.03); }
    .accent-ac { color: #c0392b; }
    .accent-ac-2 { color: #2c3e50; }
    .progress-bar-fill { background: #c0392b; }
    .watchlist-checkbox .checkmark { border: 2px solid #c0392b; }
  </style>
</head>
<body class="bg-[#071021] text-gray-100 min-h-screen font-roboto">
  <!-- Header -->
  <header class="sticky top-0 z-50 bg-black bg-opacity-70 backdrop-blur-sm shadow-lg">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-br from-[#c0392b] to-[#2c3e50] rounded-full flex items-center justify-center">
        <i class="fas fa-chess-knight text-yellow-200 text-2xl"></i>
        </div>
        <h1 class="text-2xl font-bold gradient-text marvel-font tracking-wide">Kurukshetra</h1>
      </div>
      
      <div class="flex items-center space-x-4">
        <button id="watchlist-btn" class="p-2 rounded-full hover:bg-gray-800 transition relative">
          <i class="fas fa-bookmark accent-ac"></i>
        </button>
        <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-800 transition">
          <i class="fas fa-moon accent-ac"></i>
        </button>
        <button id="search-btn" class="p-2 rounded-full hover:bg-gray-800 transition">
          <i class="fas fa-search accent-ac"></i>
        </button>
      </div>
    </div>

    <!-- Search bar (hidden by default) -->
    <div id="search-bar" class="hidden px-4 pb-4 bg-black/80">
      <div class="relative">
        <input id="global-search" type="text" placeholder="Search episodes..." 
               class="w-full bg-gray-900 border border-[#c0392b]/30 rounded-full py-2 px-4 pl-10 text-white focus:outline-none focus:ring-2 focus:ring-[#c0392b] placeholder-gray-400">
        <i class="fas fa-search absolute left-3 top-3 text-[#c0392b]"></i>
      </div>
    </div>

    <!-- Watchlist dropdown -->
    <div id="watchlist-dropdown" class="hidden absolute right-4 mt-2 w-64 bg-gray-900 border border-gray-700 rounded-lg shadow-lg z-50 py-2">
      <div class="px-4 py-2 border-b border-gray-700">
        <h3 class="font-semibold accent-ac">My Watchlist</h3>
      </div>
      <div id="watchlist-items" class="max-h-60 overflow-y-auto">
        <div class="px-4 py-3 text-center text-gray-400">Your watchlist is empty</div>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <main class="container mx-auto px-4 py-6">
    <section class="mb-12 relative overflow-hidden rounded-xl shadow-2xl">
      <div class="absolute inset-0 bg-gradient-to-r from-black via-black/70 to-transparent z-10"></div>
      <div class="relative w-full h-[420px] md:h-[520px] overflow-hidden rounded-xl">
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden">
          <!-- Period noir trailer (YouTube embed, muted loop) -->
          <iframe
            src="https://www.youtube.com/embed/AEP84U6ApSI?autoplay=1&mute=1&loop=1&playlist=AEP84U6ApSI&controls=0"
            frameborder="0"
            allow="autoplay; fullscreen"
            class="absolute top-1/2 left-1/2 w-[177.78vh] h-[100vh] min-w-full min-h-full -translate-x-1/2 -translate-y-1/2 pointer-events-none"
          ></iframe>
        </div>

        <div class="absolute bottom-0 left-0 z-20 p-6 md:p-8">
          <div class="flex items-center mb-2">
            <span class="bg-[#c0392b] text-white text-xs font-bold px-2 py-1 rounded mr-2"></span>
            <span class="text-[#c0392b] text-sm">TV Series • Seasons 1</span>
          </div>
          <h2 class="text-3xl md:text-5xl font-bold mb-2 gradient-text marvel-font tracking-wide">Kurukshetra</h2>
          <div class="flex items-center mb-4">
            <div class="flex items-center mr-4">
              <i class="fas fa-star accent-ac mr-1"></i>
              <span class="text-white">8.0</span>
            </div>
            <span class="text-gray-300 text-sm mr-4"></span>
          </div>
          <p class="text-gray-300 mb-4 max-w-lg text-sm md:text-base">An epic 18-day battle unfolds through the perspectives of 18 warriors, revealing their inner struggles and ethical challenges during a war between brothers.</p>
          <div class="flex space-x-3">
            <button id="play-all" class="btn-ac font-semibold py-2 px-6 rounded-full transition flex items-center">
              <i class="fas fa-play mr-2"></i> Play All
            </button>
            <button class="bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2 px-6 rounded-full transition flex items-center">
              <i class="fas fa-info-circle mr-2"></i> Details
            </button>
          </div>
        </div>
        <div class="absolute bottom-4 right-4 z-20">
          <button id="scroll-down" class="bg-black/50 text-[#c0392b] rounded-full p-2 border border-[#c0392b]/30 hover:bg-[#c0392b] hover:text-black transition">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- Season Navigation -->
  <div class="flex items-center justify-between mb-8 border-b border-gray-800 pb-4 container mx-auto px-4">
    <h3 class="text-xl font-semibold flex items-center">
      <i class="fas fa-tv accent-ac mr-2"></i>
      <span class="marvel-font">EPISODES</span>
    </h3>
    <div class="flex items-center space-x-2">
      <button class="season-btn active bg-[#c0392b] text-white px-3 py-1 rounded-full text-xs font-medium" data-season="all">All</button>
      <button class="season-btn px-4 py-2 rounded-full" data-season="1">Season 1</button>
      
    </div>
  </div>

  <!-- Filters -->
  <div class="flex flex-wrap items-center justify-between mb-8 gap-4 container mx-auto px-4">
    <div class="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide">
      
    </div>

    <div class="flex items-center space-x-2">
      <span class="text-gray-400 text-sm">Sort by:</span>
      <select id="sort-select" class="bg-gray-900 border border-gray-700 text-white text-sm rounded-full px-3 py-1 focus:outline-none focus:ring-1 focus:ring-[#c0392b]">
        <option>Episode Order</option>
        <option>Release Date</option>
        <option>Duration</option>
      </select>
    </div>
  </div>

  <!-- Episodes Grid -->
  <section class="container mx-auto px-4">
    <div id="movies" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
      <!-- Episode cards injected by JS -->
    </div>
  </section>

  <!-- Footer / Social -->
  <div class="border-t border-gray-800 mt-8 pt-6 text-center text-gray-500">
    <a href="#" class="text-gray-400 hover:text-[#c0392b] transition px-2"><i class="fab fa-facebook-f"></i></a>
    <a href="#" class="text-gray-400 hover:text-[#c0392b] transition px-2"><i class="fab fa-twitter"></i></a>
    <a href="https://www.instagram.com/stark_4152" class="text-gray-400 hover:text-[#c0392b] transition px-2"><i class="fab fa-instagram"></i></a>
    <a href="https://www.youtube.com/channel/UCYwTAs1PRVHbq4LnCHEEicw" class="text-gray-400 hover:text-[#c0392b] transition px-2"><i class="fab fa-youtube"></i></a>
  </div>

  <!-- Playback Modal (preserved) -->
  <div id="playback-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black bg-opacity-90">
    <div class="relative w-full max-w-4xl bg-gray-900 rounded-xl overflow-hidden shadow-2xl">
      <button id="close-modal" class="absolute top-4 right-4 z-50 text-white hover:text-[#c0392b] text-2xl bg-black/50 rounded-full p-2">
        <i class="fas fa-times"></i>
      </button>

      <div class="relative">
        <div id="modal-player">
          <video id="modal-video" class="w-full" controls playsinline>
            Your browser does not support the video tag.
          </video>
        </div>
        <div id="video-progress" class="progress-bar w-full">
          <div id="progress-bar-fill" class="progress-bar-fill" style="width: 0%"></div>
        </div>
      </div>

      <div class="p-6">
        <div class="flex justify-between items-start mb-4">
          <div>
            <h3 id="modal-title" class="text-2xl font-bold mb-1"></h3>
            <div class="flex items-center text-gray-400 text-sm">
              <span id="modal-season-ep">S1 • E1</span>
              <span class="mx-2">•</span>
              <span id="modal-duration">45 min</span>
            </div>
          </div>
          <label class="watchlist-checkbox">
            <input type="checkbox" id="watchlist-checkbox">
            <span class="checkmark"></span>
          </label>
        </div>

        <p id="modal-description" class="text-gray-300 mb-6">Loading description...</p>

        <div class="flex space-x-3">
          <button id="play-btn" class="bg-[#c0392b] hover:bg-[#e74c3c] text-white font-semibold py-2 px-6 rounded-full transition flex items-center">
            <i class="fas fa-play mr-2"></i> Play
          </button>
          <button class="bg-gray-800 hover:bg-gray-700 text-white font-semibold py-2 px-6 rounded-full transition flex items-center">
            <i class="fas fa-info-circle mr-2"></i> Details
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loading-spinner" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-[#c0392b]"></div>
  </div>

<script>
/*
  Agent Carter episodes (Season 1: 8 eps, Season 2: 10 eps).
  Titles sourced from public episode lists. (Season counts and titles verified). :contentReference[oaicite:2]{index=2}

  All video links are dummy placeholders (same format used in your other files),
  so playback behavior (HLS / MP4 / TXT / iframe / youtube handling) remains unchanged.
*/

const movies = [
  // Season 1 (8 eps)
 { title: "Sanjay", video: "https://svz.bellevianetwork.sbs:443/v4/qu/yoarde/index-f2-v1-a1.txt", image: "https://image.tmdb.org/t/p/w300/kUK1JQ0sfPt5WIf1EmuPQYnjP5y.jpg", description: "After failed peace talks between the rival Pandavas and Kauravas, Sanjay must deliver the grim message that war approaches.", duration: "45 min", season:1, episode:1, tags:["Crime","Naval"] },
  { title: "Vishwaroop", video: "https://svz.nordivisnetwork.store:443/v4/xq/trqcvl/index-f2-v1-a1.txt", image: "https://image.tmdb.org/t/p/w300/tVQ2BPm7jibxNhtbJOtUVPbeS7A.jpg", description: "As battle looms, Lord Krishna shares the Bhagavad Gita's wisdom through divine light, helping a conflicted Arjun understand his duty.", duration:"46 min", season:1, episode:2, tags:["Crime","Drama"] },
  { title: "Bhishma", video: "https://sui.cometri.store:443/v4/m9/db8ipv/index-f2-v1-a1.txt", image: "https://image.tmdb.org/t/p/w300/k2WuWwAYpbUlyJFZzum8KQJoaIF.jpg", description: "Bhishma seems to be immortal. Now the Pandavs need to find a way to defeat him. Bhishma's past is revealed.", duration:"47 min", season:1, episode:3, tags:["Naval","Crime"] },
  { title: "Dronacharya", video: "https://sy6.xylonatech.sbs:443/v4/xq/8zmlyw/index-f2-v1-a1.txt", image: "https://image.tmdb.org/t/p/w300/apKLtL26fiHTAEsMlhMEojIfirR.jpg", description: "As the new commander in charge, Dronacharya has a strategy against the Pandavas but will he be successful...?", duration:"48 min", season:1, episode:4, tags:["Drama","Crime"] },
  { title: "Abhimanyu", video: "https://sad.bellecrest.store:443/v4/ox/6mbh5o/index-f2-v1-a1.txt", image: "https://image.tmdb.org/t/p/w300/9l1KalJJJBvRm5E210tkOUCuoSf.jpg", description: "Young prince Abhimanyu faces Dronacharya's military formation in battle, leading to his defeat by Kaurava forces.", duration:"46 min", season:1, episode:5, tags:["Drama"] },
  { title: "Jayadrath", video: "https://sui.seawindart.space:443/v4/ck/hdevqp/index-f2-v1-a1.txt", image: "https://image.tmdb.org/t/p/w300/lKEyhpPkWsniCFZGu1M5iXhDVaA.jpg", description: "The Pandavas blame others for their defeat. Jayadrath's name triggers Draupadi's traumatic memories. Arjun, filled with anger, readies for battle.", duration:"50 min", season:6, episode:6, tags:["Naval","Crime"] },
  { title: "Arjun", video: "https://sri.fintravafinance.cyou:443/v4/xq/s1vacq/index-f2-v1-a1.txt", image: "https://image.tmdb.org/t/p/w300/9fhpdPOSuIox9aYpcP4cAP4A2qP.jpg", description: "With Krishna's divine help, Arjun pursues vengeance against Jayadrath while trying to overcome an ancient curse.", duration:"49 min", season:1, episode:7, tags:["Drama","Naval"] },
  { title: "Ghatotkach", video: "https://sui.moriartis.store:443/v4/rw/e86kuv/index-f2-v1-a1.txt", image: "https://image.tmdb.org/t/p/w300/lZwb4QFBAmjzVdzK2VSU8ijG0rV.jpg", description: "In a night battle led by Bheem's half-demon son Ghatotkach, the Kauravas must use their special weapon meant for Arjun.", duration: "45 min", season:1, episode:8, tags:["Crime","Naval"] },
  { title: "Yudhisthir", video: "https://sri.clarvista.shop:443/v4/ox/qpuxkb/index-f2-v1-a1.txt", image: "https://image.tmdb.org/t/p/w300/iu3w1TjY4r4YJ9nZL3cNzn6X720.jpg", description: "Injured and sidelined, Yudhishthir faces a crucial choice at a crossroads: stay true to his principles or give in to deception?", duration:"46 min", season:1, episode:9, tags:["Crime","Drama"] },
  { title: "Kripacharya", video: "https://syr.mistralstudio.shop/v4/s93/e8mp5t/cf-master.txt?v=1761290725", image: "https://image.tmdb.org/t/p/w300/axMNcBhkC4G6CqfxvvckXQ9svJV.jpg", description: "To choose the next commander, Kripacharya arranges a fierce contest between Ashwatthama and Karna, yet the clash soon spirals into uncontrollable fury and chaos.", duration:"47 min", season:1, episode:10, tags:["Naval","Crime"] },
  { title: "Kunti", video: "https://sri.bluefusion.sbs/v4/s93/wkhx9m/cf-master.txt?v=1761290745", image: "https://image.tmdb.org/t/p/w300/gBxKRzZbLFhYH3o07KyB5FAR8MU.jpg", description: "On the verge of assuming command, Karna contemplates his bond with his birth mother, Kunti, and reaffirms his solemn promise to overcome Arjuna.", duration:"48 min", season:1, episode:11, tags:["Drama","Crime"] },
  { title: "Dushasan", video: "https://sui.greenhavenstore.store/v4/s93/ie6qr9/cf-master.txt?v=1761292323", image: "https://image.tmdb.org/t/p/w300/hXSUCX0m5mfWTJ8XQstMoAIDdR1.jpg", description: "Tormented by the memory of Draupadi's dishonor, Bheem embarks on a merciless quest to hunt down Dushasana and exact his vengeance.", duration:"46 min", season:1, episode:12, tags:["Drama"] },
  { title: "Karn", video: "https://snq.velonovaenergy.sbs/v4/vz/afwbmb/cf-master.txt?v=1761290790", image: "https://image.tmdb.org/t/p/w300/A861cK5n1u9aeXfnyk68XkbfsEo.jpg", description: "Determined to overcome Arjuna, Karna enlists the expert charioteer Shalya to drive his war chariot, only to be met with the driver's mockery and the shadow of an ancient curse.", duration:"50 min", season:1, episode:13, tags:["Naval","Crime"] },
  { title: "Duryodhan", video: "https://shh.halcyonbloom.store/v4/vz/uyalee/cf-master.txt?v=1761290781", image: "https://image.tmdb.org/t/p/w300/wf9oGA9NHOQ6S7ehevpuL9xwLUx.jpg", description: "After Shalya falls, Duryodhan escapes the battle and hides in Lake Dwaipayana while the Pandavas look for him.", duration:"49 min", season:1, episode:14, tags:["Drama","Naval"] },
  { title: "Bheem", video: "https://sui.novacrestnetwork.online/v4/mik/qpyie5/cf-master.txt?v=1761293305", image: "https://image.tmdb.org/t/p/w300/pOtR0oV2cLyFwXS6UV1RyYjWhLV.jpg", description: "Duryodhana chooses Bheem as his opponent in the duel proposed by Yudhishthir. The winner takes the crown of Hastinapur for which, The Kurukshetra War began in the first place.", duration:"48 min", season:1, episode:15, tags:["Drama","Crime"] },
  { title: "Ashwatthama", video: "https://sui.corvani.cyou/v4/3vi/afwbmy/cf-master.txt?v=1761291312", image: "https://image.tmdb.org/t/p/w300/hnuMALSO8Nq8LaPujwGMvVMXWvp.jpg", description: "Enraged Ashwatthama unleashes a deadly massacre. Krishna intervenes when his revenge endangers the world.", duration:"46 min", season:1, episode:16, tags:["Drama"] },
  { title: "Stree Parv", video: "https://spc.eleviora.space/v4/x68/ie6qut/cf-master.txt?v=1761294734", image: "https://image.tmdb.org/t/p/w300/cnsFrdc0Or59I7UKkF2PjFA3k5W.jpg", description: "Gandhari, overcome with grief, encounters Krishna and curses him. The Pandava women grieve for their fallen at Kurukshetra.", duration:"50 min", season:1, episode:17, tags:["Naval","Crime"] },
  { title: "Krishn", video: "https://sy6.clarynova.cyou/v4/ck/5ajd65/cf-master.txt?v=1761291318", image: "https://image.tmdb.org/t/p/w300/79ymMcnsQvMl9ETTnTEiWZIWhAC.jpg", description: "After becoming king, Yudhishthir sees Krishn depart for Dwarka, bearing Gandhari's words as power shifts between families.", duration:"49 min", season:1, episode:18, tags:["Drama","Naval"] },

 
];

//
// --- Playback & UI logic (preserved from your uploaded file)
//
const container = document.getElementById('movies');
const searchBtn = document.getElementById('search-btn');
const searchBar = document.getElementById('search-bar');
const themeToggle = document.getElementById('theme-toggle');
const watchlistBtn = document.getElementById('watchlist-btn');
const watchlistDropdown = document.getElementById('watchlist-dropdown');
const watchlistItems = document.getElementById('watchlist-items');
const playbackModal = document.getElementById('playback-modal');
const closeModal = document.getElementById('close-modal');
const modalTitle = document.getElementById('modal-title');
const modalDescription = document.getElementById('modal-description');
const episodeNum = document.getElementById('modal-season-ep');
const modalDuration = document.getElementById('modal-duration');
const playBtn = document.getElementById('play-btn');
const watchlistCheckbox = document.getElementById('watchlist-checkbox');
const progressBarFill = document.getElementById('progress-bar-fill');
const scrollDownBtn = document.getElementById('scroll-down');
const loadingSpinner = document.getElementById('loading-spinner');
const seasonBtns = document.querySelectorAll('.season-btn');
const modalPlayer = document.getElementById('modal-player');
const globalSearch = document.getElementById('global-search');
let currentHls = null;
let currentMovieIndex = null;

function isHls(u) {
  if (!u) return false;
  return u.includes('.m3u8') || u.includes('index-') || /index.*\.txt/i.test(u) || u.includes('manifest') || u.includes('master.m3u8');
}
function isMP4(u) { return /\.mp4($|\?)/i.test(u || ''); }
function isYouTube(u) { return !!(u && (u.includes('youtube.com') || u.includes('youtu.be') || u.includes('/embed/'))); }

function resetPlayerContainer() {
  if (currentHls) { try { currentHls.destroy(); } catch(e) {} currentHls = null; }
  modalPlayer.innerHTML = `<video id="modal-video" class="w-full" controls playsinline>Your browser does not support the video tag.</video>`;
  attachVideoListeners();
}

function closeModalHandler() {
  const videoEl = document.getElementById('modal-video');
  if (currentHls) { try { currentHls.destroy(); } catch (e) {} currentHls = null; }
  if (videoEl) { try { videoEl.pause(); } catch(e) {} try { videoEl.removeAttribute('src'); videoEl.load(); } catch(e) {} }
  resetPlayerContainer();
  playbackModal.classList.add('hidden');
  document.body.style.overflow = '';
  currentMovieIndex = null;
  playBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Play';
  progressBarFill.style.width = '0%';
}

function playInModal(title, url, movieObj) {
  currentMovieIndex = movies.indexOf(movieObj);
  modalTitle.textContent = movieObj.title;
  modalDescription.textContent = movieObj.description || '';
  episodeNum.textContent = `S${movieObj.season} • E${movieObj.episode}`;
  modalDuration.textContent = movieObj.duration || '';
  watchlistCheckbox.checked = !!movieObj.inWatchlist;
  progressBarFill.style.width = '0%';
  resetPlayerContainer();

  if (!url) {
    modalTitle.textContent = title + ' — No playable URL provided';
    playbackModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    return;
  }

  // iframe hosts
  if (url.includes('streamtape.com') || url.includes('openload') || url.includes('dood')) {
    modalPlayer.innerHTML = `<iframe src="${url}" width="100%" height="100%" allowfullscreen allowtransparency allow="autoplay" scrolling="no" frameborder="0"></iframe>`;
    playbackModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadingSpinner.classList.add('hidden');
    return;
  }

  // YouTube
  if (isYouTube(url)) {
    let embedUrl = url;
    try {
      if (url.includes('watch') && url.includes('v=')) {
        const vid = new URLSearchParams(url.split('?')[1]).get('v');
        if (vid) embedUrl = `https://www.youtube.com/embed/${vid}`;
      } else if (url.includes('youtu.be/')) {
        const parts = url.split('youtu.be/');
        if (parts[1]) {
          const vid = parts[1].split(/[?&]/)[0];
          embedUrl = `https://www.youtube.com/embed/${vid}`;
        }
      }
    } catch(e){}
    modalPlayer.innerHTML = `<iframe src="${embedUrl}?autoplay=1&modestbranding=1&rel=0" width="100%" height="100%" allowfullscreen allow="autoplay; encrypted-media" frameborder="0"></iframe>`;
    playbackModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadingSpinner.classList.add('hidden');
    return;
  }

  const videoEl = document.getElementById('modal-video');

  // HLS
  if (isHls(url)) {
    if (window.Hls && Hls.isSupported()) {
      currentHls = new Hls();
      currentHls.loadSource(url);
      currentHls.attachMedia(videoEl);
      currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
        playbackModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        loadingSpinner.classList.add('hidden');
        videoEl.play().catch(()=>{});
      });
    } else {
      videoEl.src = url;
      playbackModal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      loadingSpinner.classList.add('hidden');
      videoEl.play().catch(()=>{});
    }
    return;
  }

  // MP4
  if (isMP4(url)) {
    videoEl.src = url;
    playbackModal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    loadingSpinner.classList.add('hidden');
    videoEl.play().catch(()=>{});
    return;
  }

  // Fallback
  loadingSpinner.classList.add('hidden');
  window.location.href = `player.html?title=${encodeURIComponent(title)}&video=${encodeURIComponent(url)}`;
}

function attachVideoListeners() {
  const videoEl = document.getElementById('modal-video');
  if (!videoEl) return;
  videoEl.removeEventListener('timeupdate', videoTimeUpdateHandler);
  videoEl.addEventListener('timeupdate', videoTimeUpdateHandler);
  videoEl.removeEventListener('ended', videoEndedHandler);
  videoEl.addEventListener('ended', videoEndedHandler);
}
function videoTimeUpdateHandler() {
  const videoEl = document.getElementById('modal-video');
  if (!videoEl || !videoEl.duration) return;
  const progress = (videoEl.currentTime / videoEl.duration) * 100;
  progressBarFill.style.width = progress + '%';
}
function videoEndedHandler() {
  playBtn.innerHTML = '<i class="fas fa-redo mr-2"></i> Replay';
}

/* renderMovies: same card structure as your uploaded file (preserved) */
function renderMovies(list) {
  container.innerHTML = '';
  list.forEach((movie, index) => {
    const card = document.createElement('div');
    card.className = 'movie-card fade-in rounded-xl overflow-hidden cursor-pointer';
    card.innerHTML = `
      <div class="relative group overflow-hidden rounded-xl">
        <img src="${movie.image}" alt="${movie.title}" class="w-full h-48 sm:h-56 md:h-64 object-cover rounded-xl">
        <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end p-4">
          <div>
            <h3 class="text-white font-semibold text-lg">${movie.title}</h3>
            <p class="text-gray-300 text-sm">${movie.duration || ''}</p>
          </div>
        </div>
        <div class="absolute top-3 right-3 bg-black bg-opacity-70 text-[#c0392b] rounded-full w-10 h-10 flex items-center justify-center">
          <i class="fas fa-play"></i>
        </div>
        <div class="absolute top-3 left-3 flex items-center bg-black/70 px-2 py-1 rounded-full">
          <i class="fas fa-star text-[#c0392b] text-xs mr-1"></i>
          <span class="text-white text-xs">${movie.rating || ''}</span>
        </div>
      </div>
      <div class="mt-3">
        <h3 class="text-white font-medium">${movie.title}</h3>
        <div class="flex items-center text-gray-400 text-sm mt-1">
          <span>S${movie.season} • E${movie.episode}</span>
          <span class="mx-2">•</span>
          <span>${movie.duration || ''}</span>
        </div>
      </div>
    `;
    card.addEventListener('click', () => {
      loadingSpinner.classList.remove('hidden');
      playInModal(movie.title, movie.video, movie);
    });
    container.appendChild(card);
  });
}

/* --- Initialization & UI wiring (preserved) --- */
function initPage() {
  renderMovies(movies);

  // filter button visuals (kept from original)
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const active = document.querySelector('.filter-btn.active');
      if (active) active.classList.remove('active', 'bg-[#c0392b]', 'text-white');
      this.classList.add('active', 'bg-[#c0392b]', 'text-white');
    });
  });

  // Season buttons filter
  seasonBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      seasonBtns.forEach(b => b.classList.remove('active', 'bg-[#c0392b]', 'text-white'));
      this.classList.add('active', 'bg-[#c0392b]', 'text-white');
      const season = this.dataset.season;
      let filtered;
      if (!season || season === 'all') filtered = movies;
      else filtered = movies.filter(m => String(m.season) === String(season));
      renderMovies(filtered);
    });
  });

  updateWatchlist();
}

/* Watchlist (preserved) */
function updateWatchlist() {
  watchlistItems.innerHTML = '';
  const watchlistMovies = movies.filter(m => m.inWatchlist);
  if (watchlistMovies.length === 0) {
    watchlistItems.innerHTML = '<div class="px-4 py-3 text-center text-gray-400">Your watchlist is empty</div>';
    return;
  }
  watchlistMovies.forEach((movie, idx) => {
    const index = movies.indexOf(movie);
    const item = document.createElement('div');
    item.className = 'px-4 py-3 hover:bg-gray-800 transition cursor-pointer flex items-center justify-between';
    item.innerHTML = `
      <div class="flex items-center">
        <span class="text-[#c0392b] text-sm mr-2">${idx + 1}.</span>
        <span class="text-white text-sm truncate">${movie.title}</span>
      </div>
      <button class="remove-from-watchlist text-gray-400 hover:text-red-500" data-index="${index}">
        <i class="fas fa-times"></i>
      </button>
    `;
    item.querySelector('.remove-from-watchlist').addEventListener('click', (e) => {
      e.stopPropagation();
      removeFromWatchlist(index);
    });
    item.addEventListener('click', () => {
      loadingSpinner.classList.remove('hidden');
      playInModal(movie.title, movie.video, movie);
      watchlistDropdown.classList.add('hidden');
    });
    watchlistItems.appendChild(item);
  });
}
function addToWatchlist(index) { movies[index].inWatchlist = true; updateWatchlist(); }
function removeFromWatchlist(index) { movies[index].inWatchlist = false; updateWatchlist(); }

/* UI wiring */
searchBtn.addEventListener('click', () => {
  searchBar.classList.toggle('hidden');
  watchlistDropdown.classList.add('hidden');
});
watchlistBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  watchlistDropdown.classList.toggle('hidden');
  searchBar.classList.add('hidden');
});
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('bg-gray-100');
  document.body.classList.toggle('text-gray-900');
  document.body.classList.toggle('bg-[#071021]');
  document.body.classList.toggle('text-gray-100');
  const icon = themeToggle.querySelector('i');
  if (document.body.classList.contains('bg-[#071021]')) { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); }
  else { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
});
closeModal.addEventListener('click', closeModalHandler);
playbackModal.addEventListener('click', function(e) { if (e.target === this) closeModalHandler(); });

playBtn.addEventListener('click', () => {
  const videoEl = document.getElementById('modal-video');
  if (!videoEl) return;
  if (videoEl.paused) { videoEl.play(); playBtn.innerHTML = '<i class="fas fa-pause mr-2"></i> Pause'; }
  else { videoEl.pause(); playBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Play'; }
});

watchlistCheckbox.addEventListener('change', function() {
  if (currentMovieIndex == null) return;
  if (this.checked) addToWatchlist(currentMovieIndex); else removeFromWatchlist(currentMovieIndex);
});

scrollDownBtn.addEventListener('click', () => {
  window.scrollTo({ top: document.querySelector('#movies').offsetTop - 20, behavior: 'smooth' });
});

document.addEventListener('click', (e) => {
  if (!watchlistBtn.contains(e.target) && !watchlistDropdown.contains(e.target)) watchlistDropdown.classList.add('hidden');
  if (!searchBtn.contains(e.target) && !searchBar.contains(e.target)) searchBar.classList.add('hidden');
});

// Global search (filters within current season)
globalSearch && globalSearch.addEventListener('input', (e) => {
  const q = e.target.value.trim().toLowerCase();
  const activeSeasonBtn = document.querySelector('.season-btn.active');
  const season = activeSeasonBtn ? activeSeasonBtn.dataset.season : 'all';
  let list = season === 'all' ? movies : movies.filter(m => String(m.season) === String(season));
  if (q) list = list.filter(m => m.title.toLowerCase().includes(q) || (m.description && m.description.toLowerCase().includes(q)));
  renderMovies(list);
});

attachVideoListeners();
window.addEventListener('DOMContentLoaded', initPage);
</script>
</body>
</html>
